<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Notes Visibility</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1B1B1B;
            color: #e0e0e0;
        }
        h1, h2 {
            color: #DBA33A;
        }
        button {
            padding: 10px 15px;
            background-color: #CC7B18;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 20px 0;
        }
        button:hover {
            background-color: #DD8C29;
        }
        pre {
            background-color: #252525;
            padding: 15px;
            border-radius: 4px;
            overflow: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        .output {
            margin-top: 20px;
            background-color: #252525;
            padding: 15px;
            border-radius: 4px;
            min-height: 100px;
        }
        .server-card {
            background-color: #252525;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .server-name {
            color: #DBA33A;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .server-hostname {
            color: #a0a0a0;
            margin-bottom: 10px;
        }
        .server-notes {
            color: #e0e0e0;
            font-style: italic;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #333;
            border-radius: 3px;
        }
        .server-visibility {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .server-visibility input {
            margin-right: 10px;
        }
        .server-list {
            margin-top: 30px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #333;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #CC7B18;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .save-btn {
            background-color: #7BB961;
        }
    </style>
</head>
<body>
    <h1>Homni Server Management Tool</h1>
    
    <div class="tabs">
        <div class="tab active" data-tab="fix-tab">Fix Notes Visibility</div>
        <div class="tab" data-tab="manage-tab">Manage Servers</div>
    </div>
    
    <div class="tab-content active" id="fix-tab">
        <p>This tool will update your Homni database to ensure all server notes are set to "hidden" by default.</p>
        <p>This is a one-time fix that will help ensure notes aren't accidentally displayed on your dashboard.</p>
        
        <button id="fixButton">Fix Notes Visibility</button>
        
        <div class="output" id="output">
            <p>Click the button above to fix your database.</p>
        </div>
    </div>
    
    <div class="tab-content" id="manage-tab">
        <h2>Server Management</h2>
        <p>View and edit your servers directly. Changes are saved immediately when you toggle checkboxes.</p>
        
        <div id="serverList" class="server-list">
            <p>Loading servers...</p>
        </div>
    </div>
    
    <script>
        // Constants for IndexedDB
        const DB_NAME = 'selfhosted_dashboard';
        const DB_VERSION = 1;
        const STORE_NAME = 'servers_store';
        const DB_KEY = 'servers_data';
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                
                // Load servers if switching to manage tab
                if (tab.dataset.tab === 'manage-tab') {
                    loadServers();
                }
            });
        });
        
        // Output log
        const outputDiv = document.getElementById('output');
        function log(message) {
            outputDiv.innerHTML += `<p>${message}</p>`;
            console.log(message);
        }
        
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = (event) => {
                    log(`Error opening IndexedDB: ${event.target.error}`);
                    reject(new Error("Could not open IndexedDB"));
                };
                
                request.onsuccess = (event) => {
                    resolve(request.result);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }
        
        async function fixNotesVisibility() {
            try {
                outputDiv.innerHTML = ''; // Clear previous output
                log("Starting to fix notesVisible property...");
                
                const db = await openDB();
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                const request = store.get(DB_KEY);
                
                request.onsuccess = () => {
                    if (request.result) {
                        log("‚úÖ Found data in IndexedDB");
                        const data = request.result.data;
                        
                        // Log the original values
                        data.forEach(server => {
                            log(`Server: ${server.name}, Current notesVisible: ${server.notesVisible} (${typeof server.notesVisible})`);
                        });
                        
                        // Fix the notesVisible property for all servers
                        const fixedData = data.map(server => ({
                            ...server,
                            notesVisible: false // Set all to false by default
                        }));
                        
                        log(`Found ${data.length} servers to update`);
                        
                        // Save the fixed data back to IndexedDB
                        const putRequest = store.put({
                            id: DB_KEY,
                            data: fixedData
                        });
                        
                        putRequest.onsuccess = () => {
                            log("‚úÖ Successfully fixed notesVisible property for all servers!");
                            log("üîÑ Please refresh your Homni dashboard to see the changes.");
                        };
                        
                        putRequest.onerror = (event) => {
                            log(`‚ùå Error saving fixed data to IndexedDB: ${event.target.error}`);
                        };
                    } else {
                        log("‚ùå No data found in IndexedDB. There's nothing to fix.");
                    }
                };
                
                request.onerror = (event) => {
                    log(`‚ùå Error reading from IndexedDB: ${event.target.error}`);
                };
                
                transaction.oncomplete = () => {
                    db.close();
                };
                
            } catch (error) {
                log(`‚ùå Error fixing notesVisible property: ${error.message}`);
            }
        }
        
        // Load servers for management view
        async function loadServers() {
            try {
                const serverListDiv = document.getElementById('serverList');
                serverListDiv.innerHTML = '<p>Loading servers...</p>';
                
                const db = await openDB();
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                
                const request = store.get(DB_KEY);
                
                request.onsuccess = () => {
                    if (request.result) {
                        const servers = request.result.data;
                        
                        if (servers.length === 0) {
                            serverListDiv.innerHTML = '<p>No servers found</p>';
                            return;
                        }
                        
                        // Sort servers by name
                        servers.sort((a, b) => a.name.localeCompare(b.name));
                        
                        // Create server cards
                        serverListDiv.innerHTML = '';
                        servers.forEach(server => {
                            const card = document.createElement('div');
                            card.className = 'server-card';
                            
                            const name = document.createElement('div');
                            name.className = 'server-name';
                            name.textContent = server.name;
                            
                            const hostname = document.createElement('div');
                            hostname.className = 'server-hostname';
                            hostname.textContent = server.hostname;
                            
                            card.appendChild(name);
                            card.appendChild(hostname);
                            
                            // Add notes if they exist
                            if (server.notes) {
                                const notesDiv = document.createElement('div');
                                notesDiv.className = 'server-notes';
                                notesDiv.textContent = server.notes;
                                card.appendChild(notesDiv);
                                
                                // Add visibility toggle
                                const visibilityDiv = document.createElement('div');
                                visibilityDiv.className = 'server-visibility';
                                
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.id = `visibility-${server.id}`;
                                // Use direct value with fallback to false, and add logging
                                const isVisible = !!server.notesVisible;
                                console.log(`Server ${server.name} (${server.id}) notesVisible: ${server.notesVisible} (${typeof server.notesVisible}), setting checkbox to: ${isVisible}`);
                                checkbox.checked = isVisible;
                                
                                // Add event listener to save changes immediately
                                checkbox.addEventListener('change', () => {
                                    console.log(`Checkbox for ${server.name} changed to: ${checkbox.checked}`);
                                    updateServerVisibility(server.id, checkbox.checked);
                                });
                                
                                const label = document.createElement('label');
                                label.htmlFor = `visibility-${server.id}`;
                                label.textContent = 'Show notes on dashboard';
                                
                                visibilityDiv.appendChild(checkbox);
                                visibilityDiv.appendChild(label);
                                card.appendChild(visibilityDiv);
                            }
                            
                            serverListDiv.appendChild(card);
                        });
                    } else {
                        serverListDiv.innerHTML = '<p>No data found in database</p>';
                    }
                };
                
                request.onerror = (event) => {
                    serverListDiv.innerHTML = `<p>Error loading servers: ${event.target.error}</p>`;
                };
                
                transaction.oncomplete = () => {
                    db.close();
                };
                
            } catch (error) {
                document.getElementById('serverList').innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }
        
        // Update server visibility setting
        async function updateServerVisibility(serverId, isVisible) {
            try {
                console.log(`Updating server ${serverId} visibility to: ${isVisible} (${typeof isVisible})`);
                
                const db = await openDB();
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                const request = store.get(DB_KEY);
                
                request.onsuccess = () => {
                    if (request.result) {
                        const data = request.result.data;
                        
                        // Update the specific server
                        const updatedData = data.map(server => {
                            if (server.id === serverId) {
                                console.log(`Found server ${server.name} - changing notesVisible from ${server.notesVisible} to ${isVisible}`);
                                return {
                                    ...server,
                                    notesVisible: !!isVisible // Ensure it's a boolean
                                };
                            }
                            return server;
                        });
                        
                        // Save the updated data
                        const putRequest = store.put({
                            id: DB_KEY,
                            data: updatedData
                        });
                        
                        putRequest.onsuccess = () => {
                            console.log(`Server ${serverId} visibility updated to ${isVisible}`);
                            // Show a temporary notification
                            const notification = document.createElement('div');
                            notification.textContent = 'Settings saved successfully!';
                            notification.style.position = 'fixed';
                            notification.style.top = '20px';
                            notification.style.right = '20px';
                            notification.style.padding = '10px 20px';
                            notification.style.backgroundColor = '#7BB961';
                            notification.style.color = 'white';
                            notification.style.borderRadius = '4px';
                            notification.style.zIndex = '9999';
                            document.body.appendChild(notification);
                            
                            // Remove after 2 seconds
                            setTimeout(() => {
                                document.body.removeChild(notification);
                            }, 2000);
                        };
                        
                        putRequest.onerror = (event) => {
                            console.error(`Error updating server visibility: ${event.target.error}`);
                        };
                    }
                };
                
                transaction.oncomplete = () => {
                    db.close();
                };
                
            } catch (error) {
                console.error(`Error updating server visibility: ${error.message}`);
            }
        }
        
        // Attach click event to button
        document.getElementById('fixButton').addEventListener('click', fixNotesVisibility);
    </script>
</body>
</html> 